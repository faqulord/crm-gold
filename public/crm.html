<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Core v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { 
            --bg: #050505; --sidebar: #0a0a0a; --card: #0f0f0f; 
            --primary: #ff6600; --border: #1a1a1a; --text: #fff; --dim: #555; 
        }
        * { box-sizing: border-box; transition: 0.15s ease; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); display: flex; }

        /* FIX SIDEBAR (LAPTOPRA OPTIMALIZÁLVA) */
        aside { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); height: 100vh; position: fixed; padding: 50px 35px; display: flex; flex-direction: column; z-index: 1000; }
        .logo { font-size: 0.85rem; letter-spacing: 6px; color: var(--primary); font-weight: 700; margin-bottom: 70px; text-transform: uppercase; }
        .nav-item { padding: 18px 0; color: var(--dim); text-decoration: none; cursor: pointer; display: flex; align-items: center; gap: 15px; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid transparent; }
        .nav-item:hover, .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        main { flex: 1; margin-left: 280px; padding: 60px; max-width: 1300px; width: 100%; }

        /* PERIOD SELECTOR (HAVI ZÁRÁSHOZ) */
        .selector-row { background: var(--card); padding: 25px; border: 1px solid var(--border); display: flex; gap: 25px; align-items: center; margin-bottom: 45px; }
        select { background: transparent; border: 1px solid var(--border); color: #fff; padding: 12px; font-family: inherit; cursor: pointer; border-radius: 0; }

        /* STATS */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 60px; }
        .card { background: var(--card); padding: 35px; border: 1px solid var(--border); position: relative; }
        .card::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: transparent; }
        .card:hover::after { background: var(--primary); }
        .card small { color: var(--dim); text-transform: uppercase; font-size: 0.65rem; letter-spacing: 3px; }
        .card h2 { margin: 20px 0 0; font-size: 2.5rem; font-weight: 200; letter-spacing: -1px; }

        /* TABLES */
        .table-wrap { background: var(--card); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 22px; font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 3px; border-bottom: 1px solid var(--border); }
        td { padding: 22px; border-bottom: 1px solid var(--border); font-size: 0.95rem; color: #ccc; }
        tr:hover td { color: #fff; background: rgba(255, 102, 0, 0.03); }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: var(--sidebar); padding: 60px; width: 450px; border: 1px solid var(--border); text-align: center; }
        input { width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border); padding: 18px 0; color: #fff; margin-bottom: 30px; font-family: inherit; font-size: 1.1rem; text-align: center; }
        input:focus { outline: none; border-bottom-color: var(--primary); }
        .btn { padding: 16px 40px; border-radius: 0; cursor: pointer; font-size: 0.7rem; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; border: none; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }

        #login-screen { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div style="text-align: center; width: 320px;">
            <h1 style="font-weight: 200; letter-spacing: 12px; margin-bottom: 60px;">CORE.v2</h1>
            <input type="password" id="pass" placeholder="SECURITY CODE">
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">AUTHORIZE</button>
        </div>
    </div>

    <aside>
        <div class="logo" id="l_comp">ENTERPRISE</div>
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="bi bi-layers"></i> Dashboard</div>
        <div class="nav-item" onclick="switchTab('inv', this)"><i class="bi bi-box-seam"></i> Inventory</div>
        <div class="nav-item" onclick="switchTab('parts', this)"><i class="bi bi-shield-check"></i> Partners</div>
        <div class="nav-item admin-only" id="nav-staff" onclick="switchTab('staff', this)"><i class="bi bi-person-badge"></i> Personnel</div>
        <div style="margin-top: auto;" class="nav-item" onclick="location.reload()"><i class="bi bi-lock"></i> Terminate</div>
    </aside>

    <main id="app" style="display: none;">
        <div class="header-row">
            <h1 id="h_comp" style="font-weight: 200; letter-spacing: -2px; margin-bottom: 40px;">ADMINISTRATION</h1>
        </div>

        <div class="selector-row">
            <small style="letter-spacing: 3px; color: var(--dim);">ARCHÍVUM:</small>
            <select id="sel-year" onchange="refresh()">
                <option value="2024">2024</option><option value="2025">2025</option>
                <option value="2026" selected>2026</option><option value="2027">2027</option>
            </select>
            <select id="sel-month" onchange="refresh()">
                <option value="1">Január</option><option value="2">Február</option><option value="3">Március</option>
                <option value="4">Április</option><option value="5">Május</option><option value="6">Június</option>
                <option value="7">Július</option><option value="8">Augusztus</option><option value="9">Szeptember</option>
                <option value="10">Október</option><option value="11">November</option><option value="12" selected>December</option>
            </select>
            <button class="btn btn-outline" style="padding: 10px 20px; font-size: 0.6rem;" onclick="refresh()">Adatok Frissítése</button>
        </div>

        <div id="tab-home" class="tab-content active">
            <div class="grid admin-only" id="admin-stats">
                <div class="card"><small id="lbl_rev">Revenue</small><h2 id="tot_rev">0</h2></div>
                <div class="card"><small>Expenses</small><h2 id="tot_exp" style="color: #444;">0</h2></div>
                <div class="card" style="border-color: var(--primary);"><small>Net Profit</small><h2 id="tot_profit" style="color: var(--primary);">0</h2></div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 id="lbl_list" style="letter-spacing: 3px; text-transform: uppercase; font-size: 0.75rem; color: var(--dim);">Transactions</h3>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-outline" onclick="openModal('expenses')">+ Expense</button>
                    <button class="btn btn-primary" onclick="openModal('clients')">+ Entry</button>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead><tr><th id="th_n">Entity</th><th id="th_d">Details</th><th>Amount</th><th>Action</th></tr></thead>
                    <tbody id="list-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-inv" class="tab-content" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="letter-spacing: 3px; text-transform: uppercase; font-size: 0.75rem; color: var(--dim);">Stocks</h3>
                <button class="btn btn-primary" onclick="openModal('inventory')">+ New Item</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th></th></tr></thead><tbody id="inv-body"></tbody></table></div>
        </div>

        <div id="tab-parts" class="tab-content" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="letter-spacing: 3px; text-transform: uppercase; font-size: 0.75rem; color: var(--dim);">Partners</h3>
                <button class="btn btn-primary" onclick="openModal('partners')">+ New Entity</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Name</th><th>Contact</th><th>Type</th><th></th></tr></thead><tbody id="parts-body"></tbody></table></div>
        </div>

        <div id="tab-staff" class="tab-content" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="letter-spacing: 3px; text-transform: uppercase; font-size: 0.75rem; color: var(--dim);">Staff</h3>
                <button class="btn btn-primary" onclick="openModal('employees')">+ New Member</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Name</th><th>Role</th><th>Salary</th><th></th></tr></thead><tbody id="staff-body"></tbody></table></div>
        </div>
    </main>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="m_title" style="font-weight: 200; letter-spacing: 5px; margin-bottom: 50px;">DATA ENTRY</h2>
            <div id="m_fields"></div>
            <button class="btn btn-primary" style="width: 100%;" onclick="save()">Execute</button>
        </div>
    </div>

    <script>
        let config = {}; let role = 'staff'; let activeType = '';

        async function init() {
            const res = await fetch('/api/config'); config = await res.json();
            document.getElementById('l_comp').innerText = config.companyName;
            document.getElementById('h_comp').innerText = config.companyName;

            const dict = {
                doctor: { rev: "CLINIC REVENUE", list: "PATIENTS", n: "PATIENT", d: "TREATMENT" },
                restaurant: { rev: "GASTRO REVENUE", list: "ORDERS", n: "TABLE", d: "ITEMS" },
                general: { rev: "REVENUE", list: "TRANSACTIONS", n: "ENTITY", d: "DETAILS" }
            };
            const t = dict[config.industry] || dict.general;
            document.getElementById('lbl_rev').innerText = t.rev;
            document.getElementById('lbl_list').innerText = t.list;
            document.getElementById('th_n').innerText = t.n; document.getElementById('th_d').innerText = t.d;
        }

        async function login() {
            const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password: document.getElementById('pass').value})});
            if(res.ok) { role = 'admin'; document.getElementById('login-screen').style.display='none'; document.getElementById('app').style.display='block'; document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block'); refresh(); }
            else alert('DENIED');
        }

        async function refresh() {
            const y = document.getElementById('sel-year').value;
            const m = document.getElementById('sel-month').value;
            const get = t => fetch(`/api/${t}?year=${y}&month=${m}`).then(r => r.json());
            const [c, i, p, e, ex] = await Promise.all([get('clients'), get('inventory'), get('partners'), get('employees'), get('expenses')]);

            if(role === 'admin') {
                const rev = c.reduce((s,x)=>s+x.amount,0); const exp = ex.reduce((s,x)=>s+x.amount,0); const sal = e.reduce((s,x)=>s+(x.salary||0),0);
                document.getElementById('tot_rev').innerText = rev.toLocaleString() + ' ' + config.currency;
                document.getElementById('tot_exp').innerText = (exp + sal).toLocaleString() + ' ' + config.currency;
                document.getElementById('tot_profit').innerText = (rev - exp - sal).toLocaleString() + ' ' + config.currency;
            }

            const draw = (data, target, type, fields) => {
                document.getElementById(target).innerHTML = data.map(x => `
                    <tr>${fields.map(f => `<td>${f === 'amount' || f === 'salary' || f === 'price' ? (x[f]||0).toLocaleString() : (x[f]||'')}</td>`).join('')}
                    <td style="text-align:right;"><i class="bi bi-trash" style="cursor:pointer; color:#333;" onclick="del('${type}','${x._id}')"></i></td></tr>`).join('');
            };

            draw(c, 'list-body', 'clients', ['name', 'details', 'amount']);
            draw(i, 'inv-body', 'inventory', ['name', 'qty', 'price']);
            draw(p, 'parts-body', 'partners', ['name', 'contact', 'type']);
            draw(e, 'staff-body', 'employees', ['name', 'role', 'salary']);
        }

        function openModal(type) {
            activeType = type;
            let h = `<input id="i1" placeholder="NAME / ID"><input id="i2" placeholder="DESCRIPTION"><input id="i3" type="number" placeholder="VALUE">`;
            if(type === 'employees') h = `<input id="i1" placeholder="NAME"><input id="i2" placeholder="ROLE"><input id="i3" type="number" placeholder="SALARY">`;
            if(type === 'expenses') h = `<input id="i1" placeholder="EXPENSE"><input id="i3" type="number" placeholder="AMOUNT">`;
            document.getElementById('m_fields').innerHTML = h; document.getElementById('modal').style.display = 'flex';
        }

        async function save() {
            const data = { 
                name: val('i1'), details: val('i2'), amount: Number(val('i3')||0), 
                qty: Number(val('i2')||0), price: Number(val('i3')||0), 
                contact: val('i2'), type: val('i3'), role: val('i2'), salary: Number(val('i3')||0)
            };
            await fetch('/api/'+activeType, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            document.getElementById('modal').style.display = 'none'; refresh();
        }

        async function del(type, id) { if(confirm('TERMINATE DATA?')) { await fetch(`/api/${type}/${id}`, { method: 'DELETE' }); refresh(); } }
        
        function switchTab(t, b) {
            document.querySelectorAll('.tab-content, .nav-item').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(x => x.style.display = 'none');
            document.getElementById('tab-'+t).style.display = 'block'; b.classList.add('active');
        }

        const val = id => document.getElementById(id).value;
        const closeModal = () => document.getElementById('modal').style.display = 'none';
        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Enterprise ERP Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --bg: #000; --card: #111; --primary: #3b82f6; --text: #fff; --border: #222; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }
        
        /* UI ELEMEK */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .tab-content { display: none; animation: fadeIn 0.3s; padding: 20px; }
        .tab-content.active { display: block; }
        .inp { width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 15px; border-radius: 12px; color: #fff; margin-bottom: 10px; outline: none; box-sizing: border-box; }
        .btn-blue { width: 100%; background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; }

        .stat-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .val { font-size: 2rem; font-weight: 700; color: var(--primary); }

        /* LIVE FEED & CHAT */
        .feed-item { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .feed-time { color: #555; font-size: 0.7rem; float: right; }
        #chat-box, #feed-box { height: 250px; overflow-y: auto; background: #0a0a0a; border-radius: 15px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; }

        /* TABLE */
        .table-wrap { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        td, th { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }

        .nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: #000; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-btn { background: none; border: none; color: #555; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 1.4rem; }

        #login-screen { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 id="l_comp">Betöltés...</h2>
        <input type="password" id="pass" class="inp" placeholder="Admin jelszó">
        <button class="btn-blue" onclick="login()">BELÉPÉS</button>
    </div>

    <div id="app" style="display:none;">
        <div class="header">
            <h4 id="h_comp">Vállalkozás</h4>
            <div style="font-size: 0.7rem; color: #10b981;"><i class="bi bi-circle-fill"></i> Rendszer Online</div>
        </div>

        <div id="tab-home" class="tab-content active">
            <div class="stat-card">
                <small>ÖSSZES FORGALOM</small>
                <div class="val" id="total_rev">0 Ft</div>
            </div>
            <h5>Élő Aktivitási Napló</h5>
            <div id="feed-box"></div>
            <button class="btn-blue" onclick="openModal('clients')">+ Új Rendelés / Ügyfél</button>
        </div>

        <div id="tab-inv" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h5>Raktár</h5>
                <button class="btn-blue" style="width:auto; padding:5px 15px;" onclick="openModal('inventory')">+</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Név</th><th>Készlet</th><th>Ár</th></tr></thead><tbody id="inv-list"></tbody></table></div>
        </div>

        <div id="tab-chat" class="tab-content">
            <h5>Belső Chat</h5>
            <div id="chat-box"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-in" class="inp" style="margin:0;" placeholder="Üzenet...">
                <button class="btn-blue" style="width:60px;" onclick="sendMsg()"><i class="bi bi-send"></i></button>
            </div>
        </div>

        <div id="tab-staff" class="tab-content">
            <h5>Személyzeti Kontroll</h5>
            <div class="table-wrap"><table><thead><tr><th>Név</th><th>Beosztás</th><th>Státusz</th></tr></thead><tbody id="staff-list"></tbody></table></div>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="switchTab('home', this)"><i class="bi bi-activity"></i><span>Napló</span></button>
            <button class="nav-btn" onclick="switchTab('inv', this)"><i class="bi bi-box-seam"></i><span>Raktár</span></button>
            <button class="nav-btn" onclick="switchTab('chat', this)"><i class="bi bi-chat-dots"></i><span>Chat</span></button>
            <button class="nav-btn" onclick="switchTab('staff', this)"><i class="bi bi-people"></i><span>Csapat</span></button>
            <button class="nav-btn" onclick="location.reload()"><i class="bi bi-power"></i><span>Ki</span></button>
        </div>
    </div>

    <div class="modal" id="modal">
        <div style="background:#111; padding:25px; border-radius:20px; width:100%; border:1px solid #333;">
            <h3 id="m-title">Rögzítés</h3>
            <div id="m-fields"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-blue" style="background:#222;" onclick="closeModal()">Mégse</button>
                <button class="btn-blue" id="m-save">Mentés</button>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        const val = id => document.getElementById(id).value;

        async function init() {
            const res = await fetch('/api/config');
            config = await res.json();
            document.getElementById('l_comp').innerText = config.companyName;
            document.getElementById('h_comp').innerText = config.companyName;
        }

        async function login() {
            const res = await fetch('/api/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: val('pass') })
            });
            if (res.ok) { 
                document.getElementById('login-screen').style.display = 'none'; 
                document.getElementById('app').style.display = 'block'; 
                refreshAll();
            } else { alert('Hibás jelszó!'); }
        }

        function switchTab(t, b) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            b.classList.add('active');
            refreshAll();
        }

        // ADATKEZELÉS
        function openModal(type) {
            const f = type === 'clients' ? 
                [{id:'n',p:'Név'}, {id:'d',p:'Tétel'}, {id:'a',p:'Összeg',t:'number'}] :
                [{id:'n',p:'Termék'}, {id:'q',p:'Mennyiség',t:'number'}, {id:'p',p:'Ár',t:'number'}];
            
            document.getElementById('m-fields').innerHTML = f.map(x => `<input type="${x.t||'text'}" id="${x.id}" class="inp" placeholder="${x.p}">`).join('');
            document.getElementById('m-save').onclick = () => save(type);
            document.getElementById('modal').style.display = 'flex';
        }

        async function save(type) {
            const data = type === 'clients' ? 
                { name: val('n'), details: val('d'), amount: Number(val('a')), status: 'active' } :
                { name: val('n'), qty: Number(val('q')), price: Number(val('p')), unit: 'db' };
            
            await fetch('/api/'+type, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
            closeModal();
            refreshAll();
        }

        async function sendMsg() {
            const text = val('chat-in');
            if(!text) return;
            await fetch('/api/messages', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sender: "Admin", text })});
            document.getElementById('chat-in').value = '';
            refreshAll();
        }

        async function refreshAll() {
            const get = t => fetch('/api/'+t).then(r => r.json());
            
            const [clients, inv, msgs, logs, staff] = await Promise.all([get('clients'), get('inventory'), get('messages'), get('activity'), get('employees')]);

            document.getElementById('total_rev').innerText = clients.reduce((s,i)=>s+i.amount,0).toLocaleString() + ' ' + config.currency;
            
            document.getElementById('feed-box').innerHTML = logs.map(l => `
                <div class="feed-item"><span class="feed-time">${new Date(l.date).toLocaleTimeString()}</span><b>${l.user}</b>: ${l.action}</div>
            `).join('');

            document.getElementById('chat-box').innerHTML = msgs.map(m => `
                <div style="margin-bottom:8px;"><small style="color:var(--primary)">${m.sender} • ${new Date(m.date).toLocaleTimeString()}</small><br>${m.text}</div>
            `).join('');

            document.getElementById('inv-list').innerHTML = inv.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price}</td></tr>`).join('');
            document.getElementById('staff-list').innerHTML = staff.map(s => `<tr><td>${s.name}</td><td>${s.role}</td><td><span style="color:#10b981">● Aktív</span></td></tr>`).join('');
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        init();
    </script>
</body>
</html>
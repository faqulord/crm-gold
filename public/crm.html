<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise ERP</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --bg: #050505; --side: #0a0a0a; --card: #0f0f0f; --primary: #ff6600; --border: #1a1a1a; --text: #fff; }
        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; }
        
        /* FIX BAL MENÜ */
        aside { width: 260px; background: var(--side); border-right: 1px solid var(--border); height: 100vh; position: fixed; padding: 40px 25px; display: flex; flex-direction: column; }
        .logo { color: var(--primary); font-weight: 700; letter-spacing: 3px; margin-bottom: 50px; text-transform: uppercase; font-size: 1rem; }
        .nav-btn { padding: 15px 0; color: #555; cursor: pointer; display: flex; align-items: center; gap: 15px; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid transparent; }
        .nav-btn:hover, .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        main { flex: 1; margin-left: 260px; padding: 50px; max-width: 1200px; }
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px; }
        
        /* HAVI SZŰRŐ */
        .filter-bar { background: var(--card); padding: 20px; border: 1px solid var(--border); display: flex; gap: 20px; align-items: center; margin-bottom: 40px; }
        select { background: none; border: 1px solid var(--border); color: #fff; padding: 8px; cursor: pointer; }

        /* KÁRTYÁK */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .card { background: var(--card); padding: 30px; border: 1px solid var(--border); border-top: 2px solid transparent; }
        .card:hover { border-top-color: var(--primary); }
        .card small { color: #555; text-transform: uppercase; letter-spacing: 2px; font-size: 0.65rem; }
        .card h2 { margin: 10px 0 0; font-size: 2rem; font-weight: 300; }

        /* TÁBLÁZAT */
        .box { background: var(--card); border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; font-size: 0.7rem; color: #555; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: #ccc; }
        tr:hover td { background: rgba(255,102,0,0.02); color: #fff; }

        .btn { padding: 12px 25px; cursor: pointer; font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; border: none; text-transform: uppercase; }
        .btn-p { background: var(--primary); color: #000; }
        .btn-o { background: transparent; border: 1px solid var(--border); color: #fff; }

        #login { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; align-items: center; justify-content: center; }
        input { width: 100%; background: none; border: none; border-bottom: 1px solid var(--border); padding: 12px; color: #fff; margin-bottom: 20px; outline: none; }
        
        @media (max-width: 1024px) { aside { display: none; } main { margin-left: 0; } }
    </style>
</head>
<body>

    <div id="login">
        <div style="text-align:center; width:300px;">
            <h1 id="l_title" style="font-weight:300; letter-spacing:5px; margin-bottom:40px;">LOGIN</h1>
            <input type="password" id="pass" placeholder="SECURITY CODE" style="text-align:center;">
            <button class="btn btn-p" style="width:100%;" onclick="doLogin()">AUTHORIZE</button>
        </div>
    </div>

    <aside>
        <div class="logo" id="l_comp">ENTERPRISE</div>
        <div class="nav-btn active" onclick="switchTab('home', this)"><i class="bi bi-grid-1x2"></i> Dashboard</div>
        <div class="nav-btn" onclick="switchTab('inv', this)"><i class="bi bi-box"></i> Inventory</div>
        <div class="nav-btn" onclick="switchTab('parts', this)"><i class="bi bi-person-badge"></i> Partners</div>
        <div class="nav-btn" onclick="switchTab('staff', this)"><i class="bi bi-people"></i> Personnel</div>
        <div style="margin-top:auto" class="nav-btn" onclick="location.reload()"><i class="bi bi-power"></i> Log Out</div>
    </aside>

    <main id="app" style="display:none;">
        <div class="header">
            <h1 id="h_comp" style="font-weight:300; margin:0;">ADMINISTRATION</h1>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-o" onclick="openM('expenses')">+ Expense</button>
                <button class="btn btn-p" onclick="openM('clients')">+ Record</button>
            </div>
        </div>

        <div class="filter-bar">
            <small style="color:#555; letter-spacing:2px;">PERIOD:</small>
            <select id="s-year" onchange="refresh()"><option>2025</option><option selected>2026</option></select>
            <select id="s-month" onchange="refresh()">
                <option value="1">Január</option><option value="2">Február</option><option value="3">Március</option>
                <option value="4">Április</option><option value="5">Május</option><option value="6">Június</option>
                <option value="7">Július</option><option value="8">Augusztus</option><option value="9">Szeptember</option>
                <option value="10">Október</option><option value="11">November</option><option value="12" selected>December</option>
            </select>
        </div>

        <div id="tab-home" class="tab-content">
            <div class="stats">
                <div class="card"><small id="lbl_rev">REVENUE</small><h2 id="tot_rev">0</h2></div>
                <div class="card"><small>EXPENSES</small><h2 id="tot_exp" style="color:#555">0</h2></div>
                <div class="card"><small>NET PROFIT</small><h2 id="tot_prof" style="color:var(--primary)">0</h2></div>
            </div>
            <div class="box">
                <table>
                    <thead><tr><th id="th_n">Entity</th><th id="th_d">Details</th><th>Amount</th><th></th></tr></thead>
                    <tbody id="list-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-inv" class="tab-content" style="display:none;">
            <div class="box"><table><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th></th></tr></thead><tbody id="inv-body"></tbody></table></div>
        </div>
        <div id="tab-parts" class="tab-content" style="display:none;">
            <div class="box"><table><thead><tr><th>Partner</th><th>Contact</th><th>Type</th><th></th></tr></thead><tbody id="parts-body"></tbody></table></div>
        </div>
        <div id="tab-staff" class="tab-content" style="display:none;">
            <div class="box"><table><thead><tr><th>Member</th><th>Role</th><th>Salary</th><th></th></tr></thead><tbody id="staff-body"></tbody></table></div>
        </div>
    </main>

    <div class="modal" id="modal">
        <div style="background:var(--side); padding:50px; width:400px; border:1px solid var(--border);">
            <h2 id="m_title" style="font-weight:300; letter-spacing:3px; margin-bottom:30px;">ENTRY</h2>
            <div id="m_fields"></div>
            <button class="btn btn-p" style="width:100%" onclick="save()">Execute</button>
            <button class="btn" style="width:100%; color:#555; margin-top:10px;" onclick="closeM()">Cancel</button>
        </div>
    </div>

    <script>
        let conf = {}; let activeT = '';
        async function init() {
            const r = await fetch('/api/config'); conf = await r.json();
            document.getElementById('l_comp').innerText = conf.companyName;
            document.getElementById('h_comp').innerText = conf.companyName;
            document.getElementById('l_title').innerText = conf.companyName;
            const d = {
                doctor: { r: "CLINIC REVENUE", n: "PATIENT", dt: "TREATMENT" },
                restaurant: { r: "GASTRO REVENUE", n: "TABLE", dt: "ORDER" },
                general: { r: "REVENUE", n: "ENTITY", dt: "DETAILS" }
            };
            const t = d[conf.industry] || d.general;
            document.getElementById('lbl_rev').innerText = t.r;
            document.getElementById('th_n').innerText = t.n; document.getElementById('th_d').innerText = t.dt;
        }

        async function doLogin() {
            const r = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password: document.getElementById('pass').value})});
            if(r.ok) { document.getElementById('login').style.display='none'; document.getElementById('app').style.display='block'; refresh(); } else alert('DENIED');
        }

        async function refresh() {
            const y = document.getElementById('s-year').value; const m = document.getElementById('s-month').value;
            const get = t => fetch(`/api/${t}?year=${y}&month=${m}`).then(r => r.json());
            const [c, i, p, e, ex] = await Promise.all([get('clients'), get('inventory'), get('partners'), get('employees'), get('expenses')]);
            
            const rev = c.reduce((s,x)=>s+x.amount,0); const exp = ex.reduce((s,x)=>s+x.amount,0); const sal = e.reduce((s,x)=>s+(x.salary||0),0);
            document.getElementById('tot_rev').innerText = rev.toLocaleString() + ' ' + conf.currency;
            document.getElementById('tot_exp').innerText = (exp + sal).toLocaleString() + ' ' + conf.currency;
            document.getElementById('tot_prof').innerText = (rev - exp - sal).toLocaleString() + ' ' + conf.currency;

            const draw = (data, target, type, fields) => {
                document.getElementById(target).innerHTML = data.map(x => `
                    <tr>${fields.map(f => `<td>${f.includes('amount')||f.includes('salary')||f.includes('price') ? (x[f]||0).toLocaleString() : (x[f]||'')}</td>`).join('')}
                    <td style="text-align:right;"><i class="bi bi-trash" style="cursor:pointer; color:#333;" onclick="del('${type}','${x._id}')"></i></td></tr>`).join('');
            };
            draw(c, 'list-body', 'clients', ['name', 'details', 'amount']);
            draw(i, 'inv-body', 'inventory', ['name', 'qty', 'price']);
            draw(p, 'parts-body', 'partners', ['name', 'contact', 'type']);
            draw(e, 'staff-body', 'employees', ['name', 'role', 'salary']);
        }

        function openM(t) { 
            activeT = t; let h = `<input id="i1" placeholder="NAME"><input id="i2" placeholder="DETAILS"><input id="i3" type="number" placeholder="VALUE">`;
            if(t==='employees') h = `<input id="i1" placeholder="NAME"><input id="i2" placeholder="ROLE"><input id="i3" type="number" placeholder="SALARY">`;
            document.getElementById('m_fields').innerHTML = h; document.getElementById('modal').style.display='flex'; 
        }

        async function save() {
            const d = { name: v('i1'), details: v('i2'), amount: Number(v('i3')), qty: Number(v('i2')), price: Number(v('i3')), salary: Number(v('i3')), role: v('i2'), contact: v('i2'), type: v('i3') };
            await fetch('/api/'+activeT, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)});
            closeM(); refresh();
        }

        async function del(t, id) { if(confirm('DELETE?')) { await fetch(`/api/${t}/${id}`, { method: 'DELETE' }); refresh(); } }
        function switchTab(t, b) {
            document.querySelectorAll('.tab-content').forEach(x => x.style.display='none');
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+t).style.display='block'; b.classList.add('active');
        }
        const v = id => document.getElementById(id).value;
        const closeM = () => document.getElementById('modal').style.display='none';
        init();
    </script>
</body>
</html>